<div align="center">

```
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â• 
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—
â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•    â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•
```

### **Microsoft Surface Pro 8 â€” Arch Linux Install Script**
*CachyOS-optimized kernel Â· COSMIC Desktop Â· Thermal engineering Â· Steam-ready*

---

![Arch Linux](https://img.shields.io/badge/Arch_Linux-1793D1?style=for-the-badge&logo=arch-linux&logoColor=white)
![Surface Pro 8](https://img.shields.io/badge/Surface_Pro_8-0078D4?style=for-the-badge&logo=microsoft&logoColor=white)
![COSMIC DE](https://img.shields.io/badge/COSMIC_Desktop-5E35B1?style=for-the-badge&logo=linux&logoColor=white)
![Steam](https://img.shields.io/badge/Steam-000000?style=for-the-badge&logo=steam&logoColor=white)
![Shell](https://img.shields.io/badge/Bash-4EAA25?style=for-the-badge&logo=gnu-bash&logoColor=white)
![CachyOS](https://img.shields.io/badge/CachyOS-x86--64--v3-orange?style=for-the-badge&logo=linux&logoColor=white)
![Secure Boot](https://img.shields.io/badge/Secure_Boot-sbctl-blue?style=for-the-badge&logo=linux&logoColor=white)

</div>

---

## ğŸ¯ What Is This?

A **single-script, fully automated Arch Linux installer** purpose-built for the **Microsoft Surface Pro 8**. Boot the Arch ISO, run one command, walk away. When you come back you'll have a complete, gaming-ready system with the **linux-cachyos-surface** kernel (CachyOS performance patches merged with linux-surface hardware patches), the COSMIC desktop environment, a fully engineered thermal management stack, Steam, Phantom Browser, and a system tuned at every layer for Tiger Lake gaming.

No hand-holding through `pacstrap` steps. No forgotten packages. No rebooting into a broken system.

---

## ğŸ’» Target Hardware

| Component | Spec |
|---|---|
| ğŸ–¥ï¸ **Device** | Microsoft Surface Pro 8 |
| ğŸ§  **CPU** | Intel Core i5-1135G7 (11th Gen Tiger Lake, x86-64-v3) |
| ğŸ® **GPU** | Intel Iris Xe â€” Tiger Lake-LP GT2 |
| ğŸ§© **RAM** | 8 GB LPDDR4x |
| ğŸ’¾ **Storage** | NVMe SSD (auto-detected) |
| ğŸ–±ï¸ **Input** | Surface Touch + Pen via `iptsd` |

---

## âš¡ Quickstart

> **Prerequisites:** Boot the official [Arch Linux ISO](https://archlinux.org/download/), disable Secure Boot in the Surface UEFI, connect to the internet via `iwctl` or USB-C Ethernet, then:

```bash
# 1. Download the script
curl -O https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/surface_pro8_arch_install.sh

# 2. Open it and fill in your username, password, and timezone
nano surface_pro8_arch_install.sh

# 3. Make it executable and run
chmod +x surface_pro8_arch_install.sh && bash surface_pro8_arch_install.sh
```

> âš ï¸ **This will erase your entire disk.** The script asks for confirmation before touching anything. Double-check your disk target before typing `yes`.

---

## ğŸ—‚ï¸ What The Script Does â€” Step by Step

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”  Safety checks â€” UEFI mode, network, passwords             â”‚
â”‚  ğŸ’¿  Disk detection â€” NVMe auto-detected                       â”‚
â”‚  ğŸ—‚ï¸  Partitioning â€” 1 GB EFI + root (ext4)                     â”‚
â”‚  ğŸ’¤  16 GB swapfile â€” tuned for 8 GB RAM + gaming              â”‚
â”‚  ğŸ“¦  pacstrap â€” base system + intel-ucode                      â”‚
â”‚  âš™ï¸   chroot â€” locale, users, sudo, bootloader                 â”‚
â”‚  ğŸ¥¾  systemd-boot â€” dual entries (stock fallback + cachyos)    â”‚
â”‚  ğŸ‰  CachyOS x86-64-v3 repos â€” AVX2-optimized packages        â”‚
â”‚  ğŸ§  linux-cachyos-surface â€” CachyOS + Surface patches merged  â”‚
â”‚  âœ‹  iptsd + libwacom-surface â€” touchscreen & pen daemons      â”‚
â”‚  ğŸŒ¡ï¸  throttled â€” Tiger Lake power limit watchdog               â”‚
â”‚  ğŸ“Š  Intel RAPL â€” PL1/PL2 tuning to kill the throttle lag      â”‚
â”‚  ğŸ®  Steam + Intel Xe gaming stack                             â”‚
â”‚  ğŸ”’  UFW firewall + thermald + irqbalance                      â”‚
â”‚  ğŸŒŒ  COSMIC Desktop (official Arch repos, pure pacman)         â”‚
â”‚  ğŸ‘»  Phantom Browser â€” pulled from GitHub releases             â”‚
â”‚  ğŸ”§  Deep performance tuning â€” sysctl, HWP, GuC/HuC, THP      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‰ CachyOS x86-64-v3 Repositories

The i5-1135G7 fully supports the **x86-64-v3** instruction set (AVX2, FMA3, BMI2, and more). The script adds the CachyOS optimized package repositories, which provide the entire Arch package ecosystem **recompiled with aggressive Clang/GCC flags** that the standard Arch build system never uses.

This means Steam, Mesa, glibc, Wine, and every other package on the system gets AVX2 instruction paths â€” not just the kernel.

```bash
# Only the optimized repos are added â€” no custom pacman fork
# Stays 100% compatible with standard Arch Linux workflows
[cachyos-v3]         # x86-64-v3 optimized packages
[cachyos-core-v3]    # core system packages recompiled
[cachyos-extra-v3]   # extra packages recompiled
```

> These repos sit **above** `[core]`, `[extra]`, and `[multilib]` in `pacman.conf` so optimized builds always take priority.

---

## ğŸ§ The linux-cachyos-surface Kernel

This is the centrepiece of the whole setup â€” a single kernel that combines **both** patch sets you need, built by [jonpetersathan/linux-cachyos-surface](https://github.com/jonpetersathan/linux-cachyos-surface).

### What's merged inside

| Layer | Source | What it provides |
|---|---|---|
| **linux-surface patches** | [linux-surface](https://github.com/linux-surface/linux-surface) | Touchscreen, pen, cameras, SAM controller, power buttons, Modern Standby |
| **CachyOS base patchset** | [CachyOS](https://github.com/CachyOS/linux-cachyos) | BORE scheduler, CONFIG_CACHY tweaks, low-latency patches |
| **Clang + full LTO** | LLVM toolchain | Whole-program optimisation â€” ~10% real throughput gain |
| **x86-64-v3 build** | CachyOS compiler flags | AVX2/FMA3 paths active in the kernel itself |
| **1000Hz timer** | CachyOS config | Scheduler fires 1000Ã—/sec â€” minimum scheduling latency |

### linux-cachyos-surface vs stock linux-surface

| Feature | linux-surface | linux-cachyos-surface |
|---|---|---|
| ğŸ–±ï¸ Touchscreen | âœ… | âœ… |
| âœï¸ Surface Pen | âœ… | âœ… |
| ğŸ“· Cameras | âœ… | âœ… |
| ğŸ”‹ Battery reporting | âœ… | âœ… |
| ğŸ’¤ Modern Standby | âœ… | âœ… |
| ğŸ® Gaming scheduler | âŒ Stock EEVDF | âœ… BORE |
| âš¡ Compiler | âŒ GCC -O2 | âœ… Clang LTO full |
| ğŸ§® Instruction set | âŒ Generic x86-64 | âœ… x86-64-v3 (AVX2) |
| â±ï¸ Timer frequency | âŒ 250Hz | âœ… 1000Hz |

### Installation method

The script fetches **prebuilt `.pkg.tar.zst` packages** from GitHub releases â€” no multi-hour compile on your 8 GB Surface. If no prebuilt exists in the latest release, it automatically falls back to building from source with thin LTO to keep memory usage manageable.

> `iptsd` and `libwacom-surface` still come from the linux-surface package repo as userspace daemons â€” unaffected by the kernel swap.

---

## ğŸŒ¡ï¸ Thermal Engineering â€” Solving the Throttle/Fan Surge Problem

This is the most critical section if you game on the Surface Pro 8 under Linux.

### What was happening before

```
â‘  CPU bursts at PL2 (~64W) for milliseconds
â‘¡ Temperature spikes to ~95Â°C near-instantly in the thin chassis
â‘¢ Surface EC hard-clamps back to PL1 (~15W) â€” sudden frequency cliff
â‘£ Gaming lag and stutter hit
â‘¤ Fan screams trying to catch up after the thermal event already happened
â‘¥ Repeat every 30â€“60 seconds
```

This is a **power management problem, not a fan control problem.** The fan is reacting correctly to thermal events that should never have been allowed to happen.

### The fix: three layers of thermal control

**Layer 1 â€” Intel RAPL power limits (`/etc/tmpfiles.d/intel-rapl-gaming.conf`)**

Written at every boot to both the MSR and MMIO (MCHBAR) power cap paths:

| Limit | Stock Surface | This Script | Effect |
|---|---|---|---|
| PL1 sustained | ~15W | **28W** | Higher sustained clock during gaming |
| PL1 window | 28s | **32s** | Longer before long-term throttle kicks in |
| PL2 burst | ~64W | **40W** | Burst is sane â€” no instant thermal spike |
| Trip temp (AC) | 95Â°C | **92Â°C** | SAM begins ramping fan 3Â°C earlier |

**Layer 2 â€” `throttled` daemon**

The Surface EC resets RAPL values back to its own defaults every ~5 seconds. `throttled` has explicit **Tiger Lake detection** and continuously re-applies your PL1/PL2 values to win that fight. Two profiles configured automatically:

```ini
[AC]      # Gaming on mains â€” 28W sustained / 40W burst / trip at 92Â°C
[BATTERY] # On battery    â€” 15W sustained / 25W burst / trip at 85Â°C
```

**Layer 3 â€” CPU governor + HWP energy preference**

```bash
scaling_governor              â†’ performance
energy_performance_preference â†’ performance
```

The `energy_performance_preference` pin is critical â€” without it the Intel Hardware P-State logic overrides the governor's frequency decisions with its own power-saving heuristics mid-game.

### The result

```
Before:  75Â°C â†’ spike 95Â°C â†’ hard throttle â†’ lag â†’ fan surge â†’ repeat
After:   75â€“85Â°C sustained â†’ stable clock â†’ fan at consistent moderate speed
```

### âš ï¸ Fan direct control â€” the honest explanation

The Surface Pro 8's fan is controlled **exclusively by the Surface Aggregator Module (SAM) firmware**. The Linux kernel's `surface_fan` driver exposes only `fan1_input` â€” a **read-only** RPM value. There is no PWM write interface. No tool on any OS can override the SAM's fan curve â€” this is a hardware-level constraint, not a Linux limitation.

What the thermal engineering above achieves is the correct solution: by keeping temperatures in a stable 75â€“85Â°C sustained range, the SAM sees consistent thermals and holds the fan at a steady moderate speed throughout gaming, rather than surging reactively after each thermal spike.

### Monitoring your thermals in real time

```bash
thermals      # s-tui: CPU freq, temp, power draw, utilisation â€” all on one screen
fans          # watch -n1 sensors: live fan RPM + all thermal zones every second
powerlimits   # cat RAPL sysfs â€” confirm PL1=28W, PL2=40W are being held
gpu-check     # vulkaninfo + vainfo: verify Intel Xe Vulkan + VA-API
```

---

## ğŸ® Gaming Stack

A complete Intel Iris Xe gaming environment tuned for the Surface Pro 8.

### Packages Installed

| Package | Purpose |
|---|---|
| `steam` | Game library and launcher |
| `lib32-mesa` + `lib32-vulkan-intel` | 32-bit Vulkan for older games via Proton |
| `vulkan-intel` + `vulkan-tools` | Native Vulkan for Intel Iris Xe |
| `gamemode` + `lib32-gamemode` | Automatic CPU/GPU optimisation on game launch |
| `intel-media-driver` | VA-API hardware H.264/HEVC video decode |
| `libva-utils` | `vainfo` diagnostic â€” verify VA-API is working |
| `wine-staging` + `winetricks` | Windows game compatibility layer |
| `ttf-liberation` | Font substitutes required by many Steam titles |
| `mesa-utils` + `lib32-mesa-utils` | `glxinfo` GPU diagnostics |
| `s-tui` | Real-time thermal and performance monitor |
| `lm_sensors` | Live sensor readings including Surface fan RPM |
| `irqbalance` | Distributes hardware IRQs across cores â€” reduces latency spikes |
| `msr-tools` | MSR register access required by `throttled` |

### Intel Xe GPU â€” GuC/HuC Firmware (`/etc/modprobe.d/i915-gaming.conf`)

```
enable_guc=3   GuC: GPU micro-controller handles command submission
               Offloads GPU scheduling from the CPU â†’ less driver overhead
               HuC: hardware H.264/HEVC encode/decode offload
enable_rc6=1   GPU enters low-power state between frames â†’ less heat generated
enable_fbc=1   Framebuffer compression â†’ memory bandwidth savings
enable_psr=1   Panel Self Refresh â†’ battery savings at stable framerates
```

### Steam Launch Options

```
gamemoderun %command%
```

For video-heavy games with cutscenes (enables hardware decode):
```
LIBVA_DRIVER_NAME=iHD gamemoderun %command%
```

---

## ğŸ’¤ Swap Configuration

| | Value |
|---|---|
| ğŸ’¾ Physical RAM | 8 GB |
| ğŸ”„ Swapfile | **16 GB** |
| ğŸ“ Location | `/swapfile` |
| âš™ï¸ `vm.swappiness` | `10` â€” RAM strongly preferred, swap is overflow only |
| ğŸ—‚ï¸ fstab entry | âœ… Persistent across reboots |
| âš¡ Creation method | `fallocate` â€” instant, not `dd` |

---

## ğŸ”§ Full Performance Tuning Reference

### `/etc/sysctl.d/99-gaming.conf`

```ini
# Memory
vm.swappiness = 10                   # Keep games in RAM; swap only as last resort
vm.vfs_cache_pressure = 50           # Retain filesystem cache â€” faster asset loads
vm.max_map_count = 2147483642        # Required by Proton, Steam, many Linux games
vm.dirty_ratio = 10                  # Reduce NVMe write stalls during gameplay
vm.dirty_background_ratio = 5
vm.dirty_writeback_centisecs = 1500  # Batch NVMe writes for I/O efficiency
vm.dirty_expire_centisecs = 3000

# CPU / Scheduler
kernel.sched_migration_cost_ns = 5000000  # Keep game threads on the same core longer
kernel.numa_balancing = 0                 # Not useful on single-socket mobile CPU

# Network â€” multiplayer game latency improvements
net.core.netdev_max_backlog = 16384
net.core.somaxconn = 8192
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_tw_reuse = 1
```

### Transparent Hugepages â€” `madvise` mode

```
/sys/kernel/mm/transparent_hugepage/enabled â†’ madvise
/sys/kernel/mm/transparent_hugepage/defrag  â†’ defer+madvise
```

Proton and Wine explicitly request 2 MB hugepages â€” `madvise` honours these requests without the background compaction overhead of `always` mode, which can cause frame time spikes. Persisted via `/etc/tmpfiles.d/thp-madvise.conf`.

### Boot Parameters (applied to both kernel entries)

```
mem_sleep_default=s2idle   Surface Modern Standby â€” proper sleep/wake
i915.enable_psr=1          Panel Self Refresh
i915.enable_fbc=1          Framebuffer compression
mitigations=off            Spectre/Meltdown mitigations off â€” measurable perf gain
nohz_full=1-3              Tickless idle on non-boot cores
threadirqs                 Threaded IRQs â€” smoother system response under load
nowatchdog                 Disable watchdog timer â€” removes scheduling noise
ibt=off                    Required for Proton/Wine module compatibility
```

---

## ğŸŒŒ COSMIC Desktop Environment

[COSMIC](https://github.com/pop-os/cosmic-epoch) is System76's fully Rust-native, Wayland-first desktop environment. Installed entirely from the **official Arch `extra` repository** â€” pure `pacman`, no AUR, no compiling.

```bash
pacman -S cosmic power-profiles-daemon xdg-user-dirs
systemctl enable cosmic-greeter.service
```

| Package | Why it's included |
|---|---|
| `cosmic` | Full 27-package group from Arch `extra` repo |
| `power-profiles-daemon` | Required for Power & Battery panel in COSMIC Settings |
| `xdg-user-dirs` | Creates Documents, Pictures, Videos, Downloads folders |

---

## ğŸ‘» Phantom Browser

[Phantom Browser](https://github.com/greysonofusa/degoogledchromium) is a de-Googled, privacy-hardened Chromium build based on [Cromite](https://github.com/uazo/cromite). Pulled at install time as a Linux x64 AppImage directly from the GitHub releases API.

```
âœ… All Google services removed â€” no sync, no Safe Browsing, no RLZ tracking
âœ… No telemetry or crash reporting
âœ… Built-in ad blocking (Cromite)
âœ… Brave Search + DuckDuckGo pre-installed
âœ… Auto-update checker built in
âœ… Official PhantomBrowserIcon.png pulled from repo
âœ… Symlinked to /usr/local/bin/phantom-browser
âœ… .desktop entry registered in COSMIC app launcher
```

> **Note:** The Linux AppImage build is still in progress upstream. If no Linux build exists in the latest release at install time, the script exits cleanly and prints instructions. Once the Linux build ships, it self-installs on the next run with no script changes needed.

---

## ğŸ”’ Security & Network

```
ğŸ›¡ï¸  UFW firewall
    â”œâ”€â”€ Default: deny all incoming
    â”œâ”€â”€ Default: allow all outgoing
    â””â”€â”€ Enabled and persistent via systemd

ğŸŒ¡ï¸  thermald
    â””â”€â”€ Intel thermal management daemon â€” Tiger Lake thermal zone handling

âš–ï¸  irqbalance
    â””â”€â”€ Distributes hardware interrupt load across all CPU cores
        Prevents single-core IRQ saturation during intensive gaming

ğŸ”‘  sudo
    â””â”€â”€ wheel group only â€” no passwordless sudo
```

---

## ğŸ¥¾ Boot Entries

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â˜…  Arch Linux â€” linux-cachyos-surface  [DEFAULT]               â”‚
â”‚     BORE scheduler Â· Clang LTO full Â· x86-64-v3 Â· 1000Hz timer  â”‚
â”‚     Full Surface Pro 8 hardware support                          â”‚
â”‚                                                                  â”‚
â”‚     Arch Linux â€” linux (stock)  [FALLBACK]                       â”‚
â”‚     Standard Arch kernel â€” emergency recovery use                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

A **pacman hook** automatically syncs both kernels and their initramfs images to the ESP after every `pacman -Syu`, then calls `sbctl sign-all` to re-sign the updated files â€” boot entries never go stale or unsigned after a kernel update.

---

## ğŸ” Secure Boot â€” sbctl with Auto-Signing

The script sets up a complete, self-maintaining Secure Boot chain using [sbctl](https://github.com/Foxboron/sbctl). Once configured, every `pacman -Syu` that touches a kernel or bootloader automatically re-signs the updated binaries â€” Secure Boot never breaks after an update.

### How it works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sbctl creates 3 RSA-4096 key pairs:                                â”‚
â”‚    PK  (Platform Key)      â€” root of the trust chain               â”‚
â”‚    KEK (Key Exchange Key)  â€” signs updates to the db               â”‚
â”‚    db  (Database Key)      â€” used to sign EFI binaries             â”‚
â”‚                                                                     â”‚
â”‚  All EFI binaries are signed with db:                               â”‚
â”‚    /boot/efi/EFI/systemd/systemd-bootx64.efi  (bootloader)        â”‚
â”‚    /boot/efi/EFI/BOOT/BOOTX64.EFI             (fallback loader)   â”‚
â”‚    /boot/efi/vmlinuz-linux-cachyos-surface     (primary kernel)    â”‚
â”‚    /boot/efi/vmlinuz-linux                     (fallback kernel)   â”‚
â”‚    /usr/lib/systemd/boot/efi/systemd-bootx64.efi.signed           â”‚
â”‚         â†‘ this signed source means bootctl updates stay signed too â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What the install script does automatically

The install script handles everything that can be scripted:

- Installs `sbctl`
- Generates your PK, KEK, and db key pairs (stored in `/var/lib/sbctl/keys/`)
- Signs all EFI binaries using `sbctl sign -s` (the `-s` flag saves each path to the signing database)
- Signs the systemd-boot source at `/usr/lib/` so loader updates stay signed automatically
- Enables `systemd-boot-update.service` for automatic loader maintenance
- Updates the pacman hook to call `sbctl sign-all` after every kernel update

### âš ï¸ What YOU must do manually (requires UEFI interaction)

Key enrollment into the UEFI firmware cannot be scripted â€” it requires physical interaction with the Surface UEFI. The script prints these instructions at the end of the install, but they're reproduced here for reference.

**Why `-m` (keep Microsoft's keys) is mandatory on Surface:**
The Surface Pro 8's UEFI firmware and SAM (Surface Aggregator Module) are themselves signed and verified by Microsoft's keys. Enrolling your keys without `-m` would prevent Surface UEFI firmware updates from ever working and could leave the system in an unrecoverable state.

**Step-by-step enrollment:**

```
STEP 1 â€” Put the Surface UEFI into Setup Mode
  Power off â†’ hold Volume Up + Power button together â†’ enter UEFI
  Navigate to: Security â†’ Secure Boot â†’ Clear Secure Boot Keys
  Save and exit. Boot into Arch Linux.
  (This clears the existing MS keys, putting firmware in Setup Mode)

STEP 2 â€” Confirm Setup Mode is active
  sudo sbctl status
  â†’ Must show:  Setup Mode: Enabled âœ“
  (If it shows Disabled, repeat Step 1)

STEP 3 â€” Enroll your keys alongside Microsoft's vendor keys
  sudo sbctl enroll-keys -m
  â†’ The -m flag is REQUIRED on Surface hardware

STEP 4 â€” SHUT DOWN (do NOT reboot â€” Surface-specific requirement)
  sudo shutdown now
  A direct reboot bypasses the firmware key write step.
  You must fully power off, then power back on.

STEP 5 â€” Enable Secure Boot in the UEFI
  Power on â†’ hold Volume Up + Power â†’ enter UEFI
  Navigate to: Security â†’ Secure Boot â†’ Enable Secure Boot
  Save and exit. Boot into Arch Linux.

STEP 6 â€” Verify everything is working
  sudo sbctl status
  â†’ Secure Boot: enabled  âœ“
  â†’ Vendor Keys: microsoft âœ“
  â†’ Setup Mode: Disabled  âœ“

  sudo bootctl status | grep 'Secure Boot'
  â†’ Secure Boot: enabled (user)  âœ“
```

### How auto-signing works after updates

After `sudo pacman -Syu`, the sequence is fully automatic:

```
pacman upgrades linux-cachyos-surface or systemd
       â†“
95-systemd-boot.hook fires (PostTransaction)
       â†“
New kernel/initramfs copied to ESP (/boot/efi/)
       â†“
sbctl sign-all re-signs every registered EFI binary
       â†“
sbctl re-signs /usr/lib/systemd-bootx64.efi.signed
       â†“
Next boot: UEFI verifies signature â†’ boots normally
```

You never need to manually sign anything after a routine system update.

### Troubleshooting Secure Boot

If the system fails to boot after an update, boot into the stock kernel (`linux`) fallback entry â€” it is also signed. Then run:

```bash
sudo sbctl verify        # shows what's signed and what isn't
sudo sbctl sign-all      # re-signs everything in the database
sudo sbctl list-files    # shows the full signing registry
```

If keys ever need to be rotated:
```bash
sudo sbctl rotate-keys   # generates new keys and re-signs everything
# Then repeat the enrollment steps above
```

---

## ğŸ“ Configuration â€” Edit Before Running

```bash
HOSTNAME="surface-arch"       # your machine hostname
USERNAME="yourname"           # your regular (non-root) username
USER_PASS="your-password"     # â† CHANGE THIS
ROOT_PASS="your-password"     # â† CHANGE THIS
TIMEZONE="America/Chicago"    # timedatectl list-timezones | grep America
DISK=""                       # blank = auto-detect NVMe, or e.g. /dev/nvme0n1
```

---

## ğŸ”§ Post-Install Checklist

```
â–¡  Reboot and select "linux-cachyos-surface" at the boot menu
â–¡  Log into COSMIC via cosmic-greeter
â–¡  Connect to Wi-Fi in COSMIC Settings â†’ Network
â–¡  Run 'thermals' â€” verify CPU temp and power limits look sane
â–¡  Run 'powerlimits' â€” confirm RAPL PL1=28W and PL2=40W are held
â–¡  Run 'gpu-check' â€” confirm Vulkan + VA-API are working on Iris Xe
â–¡  Open Steam â†’ Settings â†’ Compatibility â†’ Enable Steam Play for all titles
â–¡  Add 'gamemoderun %command%' to Steam game launch options
â–¡  Verify Phantom Browser appears in the COSMIC app launcher
â–¡  Always plug in AC power before gaming

â”€â”€ Secure Boot Enrollment (after first successful boot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â–¡  Check sbctl status: sudo sbctl status  (confirm keys exist)
â–¡  Enter Surface UEFI: power off â†’ hold Volume Up + Power
â–¡  Navigate to Security â†’ Secure Boot â†’ Clear Secure Boot Keys (Setup Mode)
â–¡  Save, exit, boot back into Arch
â–¡  Verify Setup Mode: sudo sbctl status  â†’ "Setup Mode: Enabled"
â–¡  Enroll keys: sudo sbctl enroll-keys -m  (the -m is mandatory on Surface)
â–¡  SHUT DOWN: sudo shutdown now  (do NOT reboot â€” Surface-specific requirement)
â–¡  Power on â†’ hold Volume Up + Power â†’ UEFI â†’ Enable Secure Boot â†’ save & exit
â–¡  Boot into Arch and verify: sudo sbctl status  â†’ "Secure Boot: enabled"
â–¡  Final verify: sudo bootctl status | grep 'Secure Boot'  â†’ "enabled (user)"
```

---

## âš ï¸ Known Limitations

- **Secure Boot setup requires physical UEFI interaction** â€” the install script generates and registers all keys and signatures automatically, but key enrollment into the firmware requires you to enter the Surface UEFI manually. Full step-by-step instructions are printed at the end of the install and documented in the [Secure Boot section](#-secure-boot--sbctl-with-auto-signing) above
- **Secure Boot was previously disabled** â€” if you're reinstalling over an existing Linux setup that had Secure Boot off, you'll need to clear existing keys in the UEFI before enrolling your sbctl keys
- **Cameras** require the linux-cachyos-surface kernel â€” will not work on stock `linux`
- **Fan speed cannot be directly controlled** â€” the Surface Aggregator Module firmware owns the fan curve. The thermal engineering in this script prevents the conditions that cause fan surges
- **Phantom Browser Linux AppImage** may not be in the latest upstream release yet â€” handled gracefully
- **linux-cachyos-surface prebuilt packages** may occasionally lag a kernel version behind â€” the script falls back to source build automatically

---

## ğŸ› ï¸ Quick Reference â€” Shell Aliases

| Alias | Command | What it shows |
|---|---|---|
| `thermals` | `s-tui` | CPU freq, temp, power draw, utilisation |
| `fans` | `watch -n1 sensors` | Live fan RPM + all thermal zones |
| `powerlimits` | RAPL sysfs cat | Verify PL1/PL2 are correctly applied |
| `gpu-check` | `vulkaninfo && vainfo` | Confirm Iris Xe Vulkan + VA-API |

---

## ğŸ™ Credits & Upstream Projects

| Project | Role |
|---|---|
| [Arch Linux](https://archlinux.org) | The base system |
| [CachyOS](https://cachyos.org) | x86-64-v3 optimized repos, BORE scheduler, kernel patches |
| [jonpetersathan/linux-cachyos-surface](https://github.com/jonpetersathan/linux-cachyos-surface) | CachyOS + linux-surface merged kernel |
| [linux-surface](https://github.com/linux-surface/linux-surface) | Surface hardware patches, iptsd, libwacom-surface |
| [System76 / COSMIC](https://github.com/pop-os/cosmic-epoch) | Desktop environment |
| [Phantom Browser](https://github.com/greysonofusa/degoogledchromium) | Privacy-focused browser |
| [Cromite](https://github.com/uazo/cromite) | Chromium base for Phantom |
| [erpalma/throttled](https://github.com/erpalma/throttled) | Tiger Lake power limit watchdog |
| [Foxboron/sbctl](https://github.com/Foxboron/sbctl) | Secure Boot key manager â€” auto-signing on kernel updates |
| [Valve / Steam](https://store.steampowered.com) | Gaming platform |
| [FeralInteractive/gamemode](https://github.com/FeralInteractive/gamemode) | Per-game CPU/GPU performance optimiser |

---

<div align="center">

**Built for privacy. Engineered for thermals. Optimized for gaming. Designed for the Surface Pro 8.**

*Pull requests and issues welcome.*

![Arch Linux](https://img.shields.io/badge/BTW_I_use-Arch-1793D1?style=flat-square&logo=arch-linux&logoColor=white)
![CachyOS](https://img.shields.io/badge/kernel-linux--cachyos--surface-orange?style=flat-square)
![Thermal](https://img.shields.io/badge/thermals-engineered-green?style=flat-square)
![Secure Boot](https://img.shields.io/badge/Secure_Boot-sbctl-blue?style=flat-square)

</div>
